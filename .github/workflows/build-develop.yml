name: Build - Develop (GHCR)

on:
  workflow_dispatch:
  push:
    branches:
      - develop
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'infrastructure/**'
      - '.github/workflows/build-develop.yml'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ghcr.io/fliteaxis/truehour-frontend
  API_IMAGE: ghcr.io/fliteaxis/truehour-api

jobs:
  prepare-database:
    name: Prepare FAA Database
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build FAA database
        run: |
          mkdir -p backend/data
          pip install -q requests
          python backend/scripts/update_faa_data.py backend/data/aircraft.db

      - name: Upload database artifact
        uses: actions/upload-artifact@v6
        with:
          name: aircraft-database
          path: backend/data/aircraft.db
          retention-days: 1

  build-api:
    name: Build API (${{ matrix.platform }})
    needs: prepare-database
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download database artifact
        uses: actions/download-artifact@v7
        with:
          name: aircraft-database
          path: backend/data

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract platform name
        id: platform
        run: echo "name=$(echo ${{ matrix.platform }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/Dockerfile
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ env.API_IMAGE }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=api-develop-${{ steps.platform.outputs.name }}
          cache-to: type=gha,mode=max,scope=api-develop-${{ steps.platform.outputs.name }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests-api
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests-api/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: digests-api-${{ steps.platform.outputs.name }}
          path: /tmp/digests-api/*
          if-no-files-found: error
          retention-days: 1

  build-frontend:
    name: Build Frontend (${{ matrix.platform }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract platform name
        id: platform
        run: echo "name=$(echo ${{ matrix.platform }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infrastructure/Dockerfile.frontend
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ env.FRONTEND_IMAGE }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=frontend-develop-${{ steps.platform.outputs.name }}
          cache-to: type=gha,mode=max,scope=frontend-develop-${{ steps.platform.outputs.name }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests-frontend
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests-frontend/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: digests-frontend-${{ steps.platform.outputs.name }}
          path: /tmp/digests-frontend/*
          if-no-files-found: error
          retention-days: 1

  merge-api:
    name: Create API Multi-Platform Manifest
    runs-on: ubuntu-latest
    needs: build-api
    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          pattern: digests-api-*
          path: /tmp/digests-api
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get metadata
        id: meta
        run: |
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Create manifest and push
        working-directory: /tmp/digests-api
        run: |
          docker buildx imagetools create \
            --tag ${{ env.API_IMAGE }}:develop \
            --tag ${{ env.API_IMAGE }}:develop-${{ steps.meta.outputs.date }} \
            --tag ${{ env.API_IMAGE }}:develop-${{ steps.meta.outputs.sha_short }} \
            $(printf '${{ env.API_IMAGE }}@sha256:%s ' *)

      - name: Inspect image
        run: docker buildx imagetools inspect ${{ env.API_IMAGE }}:develop

  merge-frontend:
    name: Create Frontend Multi-Platform Manifest
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          pattern: digests-frontend-*
          path: /tmp/digests-frontend
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get metadata
        id: meta
        run: |
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Create manifest and push
        working-directory: /tmp/digests-frontend
        run: |
          docker buildx imagetools create \
            --tag ${{ env.FRONTEND_IMAGE }}:develop \
            --tag ${{ env.FRONTEND_IMAGE }}:develop-${{ steps.meta.outputs.date }} \
            --tag ${{ env.FRONTEND_IMAGE }}:develop-${{ steps.meta.outputs.sha_short }} \
            $(printf '${{ env.FRONTEND_IMAGE }}@sha256:%s ' *)

      - name: Inspect image
        run: docker buildx imagetools inspect ${{ env.FRONTEND_IMAGE }}:develop

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [merge-api, merge-frontend]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download database artifact
        uses: actions/download-artifact@v7
        with:
          name: aircraft-database
          path: backend/data

      - name: Create test docker-compose
        run: |
          cat > docker-compose.test.yml << 'EOF'
          services:
            db:
              image: postgres:18-alpine
              environment:
                POSTGRES_DB: truehour
                POSTGRES_USER: truehour
                POSTGRES_PASSWORD: truehour
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U truehour"]
                interval: 5s
                timeout: 5s
                retries: 5
              ports:
                - "5432:5432"

            api:
              image: ${{ env.API_IMAGE }}:develop
              environment:
                DATABASE_URL: postgresql://truehour:truehour@db:5432/truehour
                ENABLE_FAA_LOOKUP: "true"
              depends_on:
                db:
                  condition: service_healthy
              ports:
                - "8000:8000"
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/health || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 5
                start_period: 10s
          EOF

      - name: Start services
        run: |
          docker compose -f docker-compose.test.yml up -d
          echo "Waiting for services to be healthy..."
          timeout 60 bash -c 'until docker compose -f docker-compose.test.yml ps | grep -q "healthy"; do sleep 2; done'

      - name: Generate test data
        run: |
          chmod +x tests/generate_test_data.sh
          API_BASE=http://localhost:8000 tests/generate_test_data.sh

      - name: Run smoke tests
        run: |
          chmod +x tests/smoke_test.sh
          API_BASE=http://localhost:8000 VERBOSE=true tests/smoke_test.sh

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== API Logs ==="
          docker compose -f docker-compose.test.yml logs api
          echo "=== DB Logs ==="
          docker compose -f docker-compose.test.yml logs db

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [merge-api, merge-frontend, smoke-test]
    steps:
      - name: Get metadata
        id: meta
        run: |
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Build Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | \`${{ env.API_IMAGE }}:develop\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`${{ env.FRONTEND_IMAGE }}:develop\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Images" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.API_IMAGE }}:develop" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.FRONTEND_IMAGE }}:develop" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Run" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.ghcr.yml pull" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.ghcr.yml up -d" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

name: Linting

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Python linting
  python-lint:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flake8 pylint black isort mypy
          pip install -r backend/requirements.txt

      - name: Run Black (formatter check)
        run: |
          black --check --diff backend/

      - name: Run isort (import sorting check)
        run: |
          isort --check-only --diff backend/

      - name: Run Flake8
        run: |
          flake8 backend/ \
            --max-line-length=120 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__,.git,__init__.py \
            --statistics \
            --count \
            --show-source

      - name: Run Pylint
        run: |
          pylint backend/app \
            --max-line-length=120 \
            --disable=C0111,R0903,R0913 \
            --output-format=colorized \
            --fail-under=8.0

      - name: Run mypy (type checking)
        run: |
          mypy backend/app \
            --ignore-missing-imports \
            --no-strict-optional \
            --warn-unused-ignores

  # JavaScript/HTML linting
  frontend-lint:
    name: Frontend Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install HTMLHint
        run: npm install -g htmlhint

      - name: Lint HTML files
        run: |
          htmlhint frontend/**/*.html

      - name: Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: frontend/
          format: text

  # Dockerfile linting
  dockerfile-lint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Lint backend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
          failure-threshold: warning
          ignore: DL3008,DL3013

      - name: Lint frontend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: infrastructure/Dockerfile.frontend
          failure-threshold: warning
          ignore: DL3008

      - name: Run Checkov on Dockerfiles
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile
          output_format: cli
          quiet: false

  # Docker Compose linting
  docker-compose-lint:
    name: Docker Compose Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate docker-compose.ghcr.yml
        run: |
          docker-compose -f infrastructure/docker-compose.ghcr.yml config > /dev/null

      - name: Lint with docker-compose-linter
        uses: docker://replicated/dockerfilelint:latest
        continue-on-error: true

      - name: Run Checkov on docker-compose files
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: docker_compose
          output_format: cli
          quiet: false

  # YAML linting
  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint .github/workflows/ infrastructure/

  # Markdown linting
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            **/*.md
            !**/node_modules/**

  # Shell script linting
  shellcheck:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning

  # Lint summary
  lint-summary:
    name: Linting Summary
    runs-on: ubuntu-latest
    needs: [python-lint, frontend-lint, dockerfile-lint, docker-compose-lint, yaml-lint, markdown-lint, shellcheck]
    if: always()
    steps:
      - name: Create lint summary
        run: |
          echo "# ðŸ§¹ Linting Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python (Black, isort, Flake8, Pylint, mypy) | \
          ${{ needs.python-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (HTML, HTMLHint) | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile (hadolint, Checkov) | ${{ needs.dockerfile-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Compose (validation, Checkov) | \
          ${{ needs.docker-compose-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML (yamllint) | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown (markdownlint) | ${{ needs.markdown-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shell Scripts (ShellCheck) | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY

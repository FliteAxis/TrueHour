name: Nightly Build (GHCR)

on:
  schedule:
    # Run daily at 6:00 AM UTC (after FAA's 11:30 PM CT update)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  API_IMAGE: ghcr.io/fliteaxis/truehour-api

jobs:
  build-database:
    name: Build FAA Database
    runs-on: ubuntu-latest
    outputs:
      records: ${{ steps.info.outputs.records }}
      size: ${{ steps.info.outputs.size }}
      date: ${{ steps.info.outputs.date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install requests

      - name: Download and build database
        run: |
          mkdir -p backend/data
          python backend/scripts/update_faa_data.py backend/data/aircraft.db

      - name: Get build info
        id: info
        run: |
          RECORDS=$(sqlite3 backend/data/aircraft.db "SELECT COUNT(*) FROM master")
          SIZE=$(du -h backend/data/aircraft.db | cut -f1)
          DATE=$(date -u +%Y-%m-%d)
          echo "records=$RECORDS" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Upload database artifact
        uses: actions/upload-artifact@v6
        with:
          name: aircraft-database
          path: backend/data/aircraft.db
          retention-days: 7

  build-api:
    name: Build API (${{ matrix.platform }})
    needs: build-database
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download database artifact
        uses: actions/download-artifact@v7
        with:
          name: aircraft-database
          path: backend/data

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract platform name
        id: platform
        run: echo "name=$(echo ${{ matrix.platform }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/Dockerfile
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ env.API_IMAGE }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=api-nightly-${{ steps.platform.outputs.name }}
          cache-to: type=gha,mode=max,scope=api-nightly-${{ steps.platform.outputs.name }}
          labels: |
            org.opencontainers.image.title=truehour-api
            org.opencontainers.image.description=TrueHour Aviation Expense Tracking API
            org.opencontainers.image.source=https://github.com/FliteAxis/TrueHour
            faa.data.records=${{ needs.build-database.outputs.records }}
            faa.data.date=${{ needs.build-database.outputs.date }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests-api
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests-api/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: digests-api-${{ steps.platform.outputs.name }}
          path: /tmp/digests-api/*
          if-no-files-found: error
          retention-days: 1

  merge-api:
    name: Create Multi-Platform Manifest
    runs-on: ubuntu-latest
    needs: [build-database, build-api]
    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          pattern: digests-api-*
          path: /tmp/digests-api
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manifest and push
        working-directory: /tmp/digests-api
        run: |
          docker buildx imagetools create \
            --tag ${{ env.API_IMAGE }}:nightly \
            --tag ${{ env.API_IMAGE }}:nightly-${{ needs.build-database.outputs.date }} \
            $(printf '${{ env.API_IMAGE }}@sha256:%s ' *)

      - name: Inspect image
        run: docker buildx imagetools inspect ${{ env.API_IMAGE }}:nightly

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-database, merge-api]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download database artifact
        uses: actions/download-artifact@v7
        with:
          name: aircraft-database
          path: .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: data-${{ needs.build-database.outputs.date }}
          name: "FAA Data - ${{ needs.build-database.outputs.date }}"
          body: |
            ## FAA Aircraft Registration Database

            **Date:** ${{ needs.build-database.outputs.date }}
            **Records:** ${{ needs.build-database.outputs.records }}
            **DB Size:** ${{ needs.build-database.outputs.size }}

            **Docker Image (Nightly):**
            ```bash
            docker pull ${{ env.API_IMAGE }}:nightly
            docker pull ${{ env.API_IMAGE }}:nightly-${{ needs.build-database.outputs.date }}
            ```

            **Downloadable Database:**
            The `aircraft.db` file is attached to this release for direct download.

            **Source:** [FAA Releasable Aircraft Database](https://www.faa.gov/licenses_certificates/aircraft_certification/aircraft_registry/releasable_aircraft_download)
          files: aircraft.db
          prerelease: false

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-database, merge-api, create-release]
    steps:
      - name: Summary
        run: |
          echo "## Nightly Build Complete ðŸŒ™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Date | ${{ needs.build-database.outputs.date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Records | ${{ needs.build-database.outputs.records }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DB Size | ${{ needs.build-database.outputs.size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.API_IMAGE }}:nightly\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull and Run" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.API_IMAGE }}:nightly" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
